(()=>{"use strict";class t{constructor(t,e,s,n){this.templateElement=document.getElementById(t),this.hostElement=document.getElementById(e);const i=document.importNode(this.templateElement.content,!0);this.element=i.firstElementChild,n&&(this.element.id=n),this.attach(s)}attach(t){this.hostElement.insertAdjacentElement(t?"beforebegin":"beforeend",this.element)}}var e;!function(t){t[t.Active=0]="Active",t[t.Finished=1]="Finished"}(e||(e={}));class s{constructor(t,e,s,n,i){this.id=t,this.task=e,this.description=s,this.date=n,this.status=i}}class n{constructor(){this.modalElement=document.querySelector("#modal"),this.taskElement=this.modalElement.querySelector("h2"),this.descriptionElement=this.modalElement.querySelector("h3"),this.dateElement=this.modalElement.querySelector("p"),this.closeButton=null}configure(){this.closeButton=this.modalElement.querySelector(".btn-close"),this.closeButton&&this.closeButton.addEventListener("click",this.close.bind(this))}open(){this.modalElement.style.display="block",this.configure()}close(){this.modalElement.style.display="none"}showTask(t){this.taskElement.textContent=t.task,this.descriptionElement.textContent=t.description,this.dateElement.textContent=t.date}}class i{constructor(){this.listeners=[]}addListener(t){this.listeners.push(t)}}class a extends i{constructor(){super(),this.tasks=[],this.modal=new n}static getInstance(){return this.instance||(this.instance=new a),this.instance}addTask(t,n,i){const a=new s(Math.random().toString(),t,n,i,e.Active);this.tasks.push(a),this.updateListeners(),this.saveTasksToLocalStorage()}removeTask(t){const e=this.tasks.findIndex((e=>e.id===t));-1!==e&&(this.tasks.splice(e,1),this.updateListeners(),this.saveTasksToLocalStorage(),this.modal.close())}moveTask(t,e){const s=this.tasks.find((e=>e.id===t));s&&s.status!==e&&(s.status=e,this.updateListeners(),this.saveTasksToLocalStorage())}initializeTasks(){this.tasks=this.fetchTasksFromLocalStorage(),this.updateListeners()}updateListeners(){for(const t of this.listeners)t(this.tasks.slice())}saveTasksToLocalStorage(){let t=JSON.stringify(this.tasks);localStorage.setItem("data",t)}fetchTasksFromLocalStorage(){const t=localStorage.getItem("data");return t?JSON.parse(t):[]}}const r=a.getInstance();function l(t,e,s){const n=s.value;return{configurable:!0,get(){return n.bind(this)}}}class o extends t{constructor(){super("input-group","app",!1),this.taskInputElement=this.element.querySelector("#task"),this.descriptionInputElement=this.element.querySelector("#description"),this.dateInputElement=this.element.querySelector("#date"),this.configure()}configure(){this.element.addEventListener("submit",this.submitHandler)}renderContent(){}clearInputs(){this.taskInputElement.value="",this.descriptionInputElement.value="",this.dateInputElement.value=""}gatherUserInput(){const t=this.taskInputElement.value,e=this.descriptionInputElement.value,s=this.dateInputElement.value;return 0===t.trim().length||0===e.trim().length||0===s.trim().length?void alert("入力値が正しくありません。"):[t,e,s]}submitHandler(t){t.preventDefault();const e=this.gatherUserInput();if(Array.isArray(e)){const[t,s,n]=e;r.addTask(t,s,n),this.clearInputs()}}}!function(t,e,s,n){var i,a=arguments.length,r=a<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,s):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,s,n);else for(var l=t.length-1;l>=0;l--)(i=t[l])&&(r=(a<3?i(r):a>3?i(e,s,r):i(e,s))||r);a>3&&r&&Object.defineProperty(e,s,r)}([l],o.prototype,"submitHandler",null);class d{constructor(t){this.isDragging=!1,this.startPosX=0,this.startPosY=0,this.offsetX=0,this.offsetY=0,this.element=t,this.rect=this.element.getBoundingClientRect(),this.windowScrollX=window.scrollX||window.pageXOffset,this.windowScrollY=window.scrollY||window.pageYOffset}handleTouchStart(t){if(1!==t.touches.length)return;this.element.classList.add("dragging");const e=t.touches[0];this.isDragging=!0,this.startPosX=e.pageX-this.windowScrollX-this.rect.width,this.startPosY=e.pageY-this.windowScrollY-this.rect.height,this.offsetX=e.pageX-this.rect.width,this.offsetY=e.pageY-this.rect.height,t.stopImmediatePropagation()}handleTouchMove(t){if(!this.isDragging||1!==t.touches.length)return;const e=t.touches[0].pageY-this.offsetY-this.rect.height;this.element.style.top=`${e}px`,t.preventDefault()}handleTouchEnd(t){this.isDragging=!1,this.element.classList.remove("dragging"),console.log("drag end"),t.preventDefault()}}var c=function(t,e,s,n){var i,a=arguments.length,r=a<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,s):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,s,n);else for(var l=t.length-1;l>=0;l--)(i=t[l])&&(r=(a<3?i(r):a>3?i(e,s,r):i(e,s))||r);return a>3&&r&&Object.defineProperty(e,s,r),r};class h extends t{constructor(t,e){super("single-task",t,!1,e.id),this.task=e,this.modal=new n,this.draggable=new d(this.element),this.templateElement=document.getElementById("modal-template"),this.configure(),this.renderContent()}configure(){const t=this.element.querySelector("#modal-btn");t.addEventListener("click",this.clickHandler,{passive:!0}),t.addEventListener("touchstart",this.clickHandler,{passive:!0}),this.element.addEventListener("dragstart",this.dragStartHandler,{passive:!1}),this.element.addEventListener("dragend",this.dragEndHandler,{passive:!1}),this.element.addEventListener("touchstart",(t=>{this.draggable.handleTouchStart(t)}),{passive:!1}),this.element.addEventListener("touchmove",(t=>{this.draggable.handleTouchMove(t)}),{passive:!1}),this.element.addEventListener("touchend",(t=>{this.draggable.handleTouchEnd(t)}),{passive:!1})}renderContent(){this.element.querySelector("h2").textContent=this.task.task}clickHandler(){const t=this.templateElement.content.cloneNode(!0),e=t.querySelector("h2"),s=t.querySelector("h3"),n=t.querySelector("p");t.querySelector("#delete-btn").addEventListener("click",this.deleteHandler),e.textContent=this.task.task,s.textContent=`<詳細> ${this.task.description}`,n.textContent=`<完了日> ${this.task.date}`;const i=document.querySelector("#modal");i.innerHTML="",i.appendChild(t),this.modal.open()}deleteHandler(){r.removeTask(this.task.id),this.element.remove()}dragStartHandler(t){t.dataTransfer&&(t.dataTransfer.setData("text/plain",this.task.id),t.dataTransfer.effectAllowed="move")}dragEndHandler(t){console.log("Drag end")}}c([l],h.prototype,"clickHandler",null),c([l],h.prototype,"deleteHandler",null),c([l],h.prototype,"dragStartHandler",null);var u=function(t,e,s,n){var i,a=arguments.length,r=a<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,s):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,s,n);else for(var l=t.length-1;l>=0;l--)(i=t[l])&&(r=(a<3?i(r):a>3?i(e,s,r):i(e,s))||r);return a>3&&r&&Object.defineProperty(e,s,r),r};class p extends t{constructor(t){super("task-list","app",!0,`${t}-tasks`),this.type=t,this.assignedTasks=[],this.configure(),this.renderContent(),this.initializeTasks()}dragOverHandler(t){t.dataTransfer&&"text/plain"===t.dataTransfer.types[0]&&(t.preventDefault(),this.element.querySelector("ul").classList.add("droppable"))}dropHandler(t){t.preventDefault();const s=t.dataTransfer.getData("text/plain");r.moveTask(s,"active"===this.type?e.Active:e.Finished)}dragLeaveHandler(t){this.element.querySelector("ul").classList.remove("droppable")}touchStartHandler(t){console.log("touch start"),this.element.querySelector("ul").classList.add("droppable")}touchEndHandler(t){console.log("touch end"),this.element.querySelector("ul").classList.remove("droppable");const s=t.currentTarget.id;s&&r.moveTask(s,"active"===this.type?e.Active:e.Finished),this.checkAndUpdateTaskStatus()}configure(){this.element.addEventListener("dragover",this.dragOverHandler,{passive:!1}),this.element.addEventListener("drop",this.dropHandler,{passive:!1}),this.element.addEventListener("dragleave",this.dragLeaveHandler,{passive:!1}),this.element.addEventListener("touchstart",this.touchStartHandler,{passive:!1}),this.element.addEventListener("touchend",this.touchEndHandler,{passive:!1}),r.addListener((t=>{console.log("taskState.addListener()");const s=t.filter((t=>"active"===this.type?t.status===e.Active:t.status===e.Finished));this.assignedTasks=s,this.checkAndUpdateTaskStatus()}))}renderContent(){const t=`${this.type}-tasks-list`;this.element.querySelector("ul").id=t,this.element.querySelector("h2").textContent="active"===this.type?"実行中のタスク":"完了済みタスク"}checkAndUpdateTaskStatus(){const t=document.getElementById(`${this.type}-tasks-list`);t.innerHTML="";for(const s of this.assignedTasks){const n=s.id,i=this.assignedTasks.find((t=>t.id===n));if(i){const s="active"===this.type?e.Active:e.Finished;i.status!==s&&(console.log("checkAndUpdateTaskStatus()"),i.status=s,new h(t.id,i))}new h(t.id,s)}}initializeTasks(){"active"!==this.type&&"finished"!==this.type||(r.initializeTasks(),console.log("initializeTasks()"))}}u([l],p.prototype,"dragOverHandler",null),u([l],p.prototype,"dropHandler",null),u([l],p.prototype,"dragLeaveHandler",null),u([l],p.prototype,"touchStartHandler",null),u([l],p.prototype,"touchEndHandler",null),new o,new p("active"),new p("finished")})();